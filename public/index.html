<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Timetable AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdown + Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    :root { --glass: rgba(15,23,42,.75); }
    body{
      background: radial-gradient(1200px 600px at 20% -10%, #1d2a5b33, transparent 70%),
                  radial-gradient(1000px 500px at 100% 0%, #0ea5e933, transparent 60%),
                  linear-gradient(135deg, #0b1020 0%, #0f172a 50%, #0b1222 100%);
      color:#e5e7eb;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    .card{
      background:var(--glass);
      border:1px solid rgba(148,163,184,.25);
      backdrop-filter: blur(8px);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .ring-sky{ box-shadow: 0 0 0 2px rgba(56,189,248,.6) inset; }
    .pulse-dot{ box-shadow:0 0 0 0 rgba(34,197,94,.5); animation:pulse 1.6s infinite; }
    @keyframes pulse{ 0%{box-shadow:0 0 0 0 rgba(34,197,94,.5)} 70%{box-shadow:0 0 0 16px rgba(34,197,94,0)} 100%{box-shadow:0 0 0 0 rgba(34,197,94,0)} }
    .skeleton{ background: linear-gradient(90deg,#0b1222,#0f172a 50%,#0b1222); background-size: 200% 100%; animation: sk 1.2s linear infinite; }
    @keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* Markdown formatting */
    .markdown-body h1,.markdown-body h2,.markdown-body h3{font-weight:600;margin-top:1rem}
    .markdown-body p,.markdown-body li{margin:0.3rem 0}
    .markdown-body table{border-collapse:collapse;width:100%;margin:0.5rem 0;font-size:0.95rem}
    .markdown-body th,.markdown-body td{border:1px solid #334155;padding:4px 6px;text-align:left}
    .markdown-body code{background:#0f172a;border-radius:4px;padding:2px 4px;font-family:monospace}
    .markdown-body strong{color:#fbbf24}
    .markdown-body em{color:#a5b4fc}
  </style>
</head>
<body class="min-h-screen flex items-center justify-center py-6 px-3 sm:py-10 sm:px-4">

  <main class="w-full max-w-3xl space-y-4 sm:space-y-5">
    <!-- Header -->
    <header class="flex items-center justify-between px-1">
      <h1 class="text-xl sm:text-2xl font-semibold tracking-tight flex items-center gap-2">
        <span class="text-pink-400 text-2xl sm:text-3xl"></span> Timetable AI
      </h1>
      <div class="flex items-center gap-2 text-xs sm:text-sm text-slate-400">
        <span class="w-2.5 h-2.5 rounded-full bg-emerald-400 pulse-dot"></span>
        Ready
      </div>
    </header>

    <!-- Composer -->
    <section class="card rounded-2xl p-3 sm:p-4">
      <label for="q" class="block text-xs sm:text-sm text-slate-400 mb-2">Ask a question</label>

      <div class="relative">
        <input id="q" autocomplete="off"
               placeholder="e.g. When are Kuang Wen’s free periods tomorrow?"
               class="w-full rounded-2xl bg-slate-950/60 border border-slate-700/60 pl-4 pr-24 py-3 text-base
                      focus:outline-none focus:ring-2 focus:ring-sky-400/70 placeholder:text-slate-500" />

        <!-- Mic button (fills the input after STT) -->
        <button id="micBtn" type="button"
                class="absolute right-2 top-1/2 -translate-y-1/2 inline-flex items-center gap-2
                       rounded-xl px-3 py-2 bg-slate-800/70 border border-slate-700/60 text-slate-200
                       hover:bg-slate-700 transition-all"
                aria-label="Record with microphone" title="Record with microphone">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
               class="w-4 h-4"><path fill="currentColor"
               d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3m5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0zM11 19v2h2v-2z"/></svg>
          <span class="text-sm">Mic</span>
        </button>
      </div>

      <div class="mt-3 flex items-center gap-2">
        <button id="askBtn" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl
                                   bg-indigo-600 hover:bg-indigo-500 transition-all font-semibold">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
               class="w-5 h-5"><path fill="currentColor"
               d="M4 12h11.17l-4.58-4.59L12 6l6 6l-6 6l-1.41-1.41L15.17 13H4z"/></svg>
          Ask
        </button>
        <p id="status" class="text-sm text-slate-400"></p>
      </div>
    </section>

    <!-- Answer -->
    <section class="card rounded-2xl p-4 sm:p-5">
      <h2 class="text-lg font-semibold mb-2">Answer</h2>
      <div id="answer" class="markdown-body min-h-[90px] text-base leading-7 text-slate-100">
        <span class="text-slate-400">Ask something to get started.</span>
      </div>
    </section>

    <!-- Raw JSON dropdown -->
    <details class="card rounded-2xl p-3 sm:p-4 select-text" id="rawDetails">
      <summary class="cursor-pointer list-none flex items-center justify-between">
        <span class="font-semibold">Raw JSON (collapsed)</span>
        <span id="rawMeta" class="text-xs text-slate-400"></span>
      </summary>
      <div class="mt-3">
        <div class="flex items-center gap-2 mb-2">
          <button id="copyBtn" class="px-3 py-1.5 rounded-lg text-sm bg-slate-800 border border-slate-700 hover:bg-slate-700">Copy JSON</button>
          <span id="copyTip" class="text-xs text-slate-400"></span>
        </div>
        <pre id="raw" class="max-h-80 overflow-auto rounded-xl p-3 bg-slate-950/70 border border-slate-800 text-[13px]"></pre>
      </div>
    </details>

    <!-- Names (localStorage) -->
    <details class="card rounded-2xl p-3 sm:p-4">
      <summary class="cursor-pointer list-none flex items-center justify-between">
        <span class="font-semibold">Names (saved locally)</span>
        <span class="text-xs text-slate-400">one per line</span>
      </summary>
      <div class="mt-3">
        <textarea id="namesBox" rows="6"
                  placeholder="Kuang Wen&#10;Gabriel&#10;Adrian"
                  class="w-full rounded-xl bg-slate-950/60 border border-slate-700/60 p-3
                         focus:outline-none focus:ring-2 focus:ring-sky-400/70 placeholder:text-slate-500"></textarea>
        <div class="flex gap-2 mt-2">
          <button id="saveNames" class="px-3 py-1.5 rounded-lg text-sm bg-slate-800 border border-slate-700 hover:bg-slate-700">Save</button>
          <button id="clearNames" class="px-3 py-1.5 rounded-lg text-sm bg-slate-800 border border-slate-700 hover:bg-slate-700">Clear</button>
        </div>
      </div>
    </details>
  </main>

  <script>
    const qEl = document.getElementById('q');
    const askBtn = document.getElementById('askBtn');
    const micBtn = document.getElementById('micBtn');
    const statusEl = document.getElementById('status');
    const ansEl = document.getElementById('answer');
    const rawEl = document.getElementById('raw');
    const rawMeta = document.getElementById('rawMeta');
    const copyBtn = document.getElementById('copyBtn');
    const copyTip = document.getElementById('copyTip');
    const rawDetails = document.getElementById('rawDetails');

    const namesBox = document.getElementById('namesBox');
    const saveNames = document.getElementById('saveNames');
    const clearNames = document.getElementById('clearNames');

    let recording = false, mediaStream = null, mediaRecorder = null, recordTimer = null;

    function clearOutput() {
      ansEl.innerHTML = '<div class="h-6 rounded skeleton"></div><div class="h-6 rounded skeleton mt-2 w-3/4"></div>';
      rawEl.textContent = '';
      rawMeta.textContent = '';
      rawDetails.open = false;
    }

    async function ask() {
      const question = qEl.value.trim();
      if (!question) return;
      clearOutput();
      setStatus('Sending…');
      askBtn.disabled = true;
      micBtn.disabled = true;

      try {
        const apiRes = await fetch('/proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, mode: 'auto' })
        });
        const data = await apiRes.json();

        rawEl.textContent = JSON.stringify(data, null, 2);
        const count = Array.isArray(data?.results) ? data.results.length : 0;
        rawMeta.textContent = `items: ${count}`;

        setStatus('Summarizing…');
        const results = Array.isArray(data?.results) ? data.results : [];
        const sumRes = await fetch('/summarize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, results })
        });
        const j = await sumRes.json();
        const summary = j?.choices?.[0]?.message?.content
                     || j?.openai_raw?.choices?.[0]?.message?.content
                     || 'No summary produced.';

        const html = DOMPurify.sanitize(marked.parse(summary || ''));
        ansEl.innerHTML = html;

        setStatus('Done');
      } catch (err) {
        ansEl.innerHTML = '<span class="text-red-400">Something went wrong.</span>';
        setStatus('Error');
        console.error(err);
      } finally {
        askBtn.disabled = false;
        micBtn.disabled = false;
      }
    }

    function setStatus(t){ statusEl.textContent = t || ''; }

    // ENTER to ask
    qEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ask(); }
    });
    askBtn.addEventListener('click', ask);

    // Copy JSON
    copyBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(rawEl.textContent || '');
        copyTip.textContent = 'Copied!';
        setTimeout(() => copyTip.textContent = '', 1200);
      } catch {}
    });

    // --- Mic handling (fills input with STT result) ---
    micBtn.addEventListener('click', async () => {
      try {
        if (!navigator.mediaDevices || !window.MediaRecorder) {
          return alert('Microphone recording not supported on this device/browser.');
        }

        if (!recording) {
          // start recording
          clearOutput();
          setStatus('Recording… Tap again to stop');
          micBtn.classList.add('ring-sky');

          mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' });
          const chunks = [];
          mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
          mediaRecorder.onstop = async () => {
            recording = false;
            micBtn.classList.remove('ring-sky');
            setStatus('Transcribing…');

            const blob = new Blob(chunks, { type: 'audio/webm' });
            const form = new FormData();
            form.append('audio', blob, 'question.webm');

            try {
              const r = await fetch('/whisper', { method: 'POST', body: form });
              const j = await r.json();
              if (j?.text) {
                qEl.value = j.text;         // ✅ fill the box
                qEl.focus();
                qEl.setSelectionRange(qEl.value.length, qEl.value.length);
              } else {
                alert('No text returned from transcription.');
              }
              setStatus('Ready');
            } catch (e) {
              console.error(e);
              setStatus('Transcription error');
            } finally {
              mediaStream.getTracks().forEach(t => t.stop());
            }
          };
          mediaRecorder.start();
          recording = true;
          // auto-stop after 6s (mobile-friendly)
          recordTimer = setTimeout(() => { if (recording) mediaRecorder.stop(); }, 6000);
        } else {
          // stop recording
          clearTimeout(recordTimer);
          mediaRecorder.stop();
        }
      } catch (e) {
        console.error(e);
        setStatus('Mic unavailable');
      }
    });

    // --- Names (localStorage) ---
    function loadNames() {
      namesBox.value = localStorage.getItem('ttai:names') || '';
    }
    function saveNamesToLS() {
      localStorage.setItem('ttai:names', namesBox.value.trim());
    }
    saveNames.addEventListener('click', () => { saveNamesToLS(); alert('Saved'); });
    clearNames.addEventListener('click', () => { localStorage.removeItem('ttai:names'); namesBox.value=''; });
    loadNames();
  </script>
</body>
</html>
