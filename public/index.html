<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Timetable AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    :root { --glass: rgba(15,23,42,.75); }
    body{
      background: radial-gradient(1200px 600px at 20% -10%, #1d2a5b33, transparent 70%),
                  radial-gradient(1000px 500px at 100% 0%, #0ea5e933, transparent 60%),
                  linear-gradient(135deg, #0b1020 0%, #0f172a 50%, #0b1222 100%);
      color:#e5e7eb; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    .card{ background:var(--glass); border:1px solid rgba(148,163,184,.25); backdrop-filter: blur(8px);
           box-shadow:0 20px 60px rgba(0,0,0,.35); }
    .ring-sky{ box-shadow: 0 0 0 2px rgba(56,189,248,.6) inset; }
    .skeleton{ background: linear-gradient(90deg,#0b1222,#0f172a 50%,#0b1222); background-size: 200% 100%;
               animation: sk 1.2s linear infinite; } @keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .markdown-body h1,.markdown-body h2,.markdown-body h3{font-weight:600;margin-top:1rem}
    .markdown-body p,.markdown-body li{margin:0.3rem 0}
    .markdown-body table{border-collapse:collapse;width:100%;margin:0.5rem 0;font-size:0.95rem}
    .markdown-body th,.markdown-body td{border:1px solid #334155;padding:4px 6px;text-align:left}
    .markdown-body code{background:#0f172a;border-radius:4px;padding:2px 4px;font-family:monospace}
    /* Modal */
    .modal-mask{ position:fixed; inset:0; background:rgba(2,6,23,.55); backdrop-filter: blur(4px); display:none; }
    .modal{ width:min(720px,96vw); max-height:90vh; overflow:auto; background:rgba(17,24,39,.96);
            border:1px solid #334155; border-radius:16px; margin:6vh auto; padding:16px; }
    .modal.show{ display:block; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center py-6 px-3 sm:py-10 sm:px-4">

  <main class="w-full max-w-3xl space-y-5">
    <!-- Top bar (no emojis) -->
    <header class="flex items-center justify-between px-1">
      <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">Timetable AI</h1>
      <div class="flex items-center gap-2">
        <button id="manageNamesBtn"
                class="px-3 py-1.5 text-sm rounded-lg bg-slate-800/80 border border-slate-700 hover:bg-slate-700">
          Names
        </button>
        <span class="hidden sm:inline text-sm text-slate-400">Ready</span>
      </div>
    </header>

    <!-- Composer -->
    <section class="card rounded-2xl p-3 sm:p-4">
      <label for="q" class="block text-xs sm:text-sm text-slate-400 mb-2">Ask a question</label>
      <div class="relative">
        <input id="q" autocomplete="off"
               placeholder="e.g. When are Kuang Wen’s free periods tomorrow?"
               class="w-full rounded-2xl bg-slate-950/60 border border-slate-700/60 pl-4 pr-24 py-3 text-base
                      focus:outline-none focus:ring-2 focus:ring-sky-400/70 placeholder:text-slate-500" />
        <!-- Mic button -->
        <button id="micBtn" type="button"
                class="absolute right-2 top-1/2 -translate-y-1/2 inline-flex items-center gap-2
                       rounded-xl px-3 py-2 bg-slate-800/70 border border-slate-700/60 text-slate-200
                       hover:bg-slate-700 transition-all"
                aria-label="Record with microphone" title="Record with microphone">Mic</button>
      </div>
      <div class="mt-3 flex items-center gap-2">
        <button id="askBtn" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl
                                   bg-indigo-600 hover:bg-indigo-500 transition-all font-semibold">
          Ask
        </button>
        <p id="status" class="text-sm text-slate-400"></p>
      </div>
    </section>

    <!-- Answer -->
    <section class="card rounded-2xl p-4 sm:p-5">
      <h2 class="text-lg font-semibold mb-2">Answer</h2>
      <div id="answer" class="markdown-body min-h-[90px] text-base leading-7 text-slate-100">
        <span class="text-slate-400">Ask something to get started.</span>
      </div>
    </section>

    <!-- Raw JSON dropdown -->
    <details class="card rounded-2xl p-3 sm:p-4 select-text" id="rawDetails">
      <summary class="cursor-pointer list-none flex items-center justify-between">
        <span class="font-semibold">Raw JSON (collapsed)</span>
        <span id="rawMeta" class="text-xs text-slate-400"></span>
      </summary>
      <div class="mt-3">
        <div class="flex items-center gap-2 mb-2">
          <button id="copyBtn" class="px-3 py-1.5 rounded-lg text-sm bg-slate-800 border border-slate-700 hover:bg-slate-700">Copy JSON</button>
          <span id="copyTip" class="text-xs text-slate-400"></span>
        </div>
        <pre id="raw" class="max-h-80 overflow-auto rounded-xl p-3 bg-slate-950/70 border border-slate-800 text-[13px]"></pre>
      </div>
    </details>
  </main>

  <!-- Names Modal -->
  <div id="namesModal" class="modal-mask">
    <div class="modal rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Manage Names</h3>
        <button id="closeNames"
                class="px-3 py-1.5 text-sm rounded-lg bg-slate-800/80 border border-slate-700 hover:bg-slate-700">
          Close
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <!-- Lists column -->
        <div class="sm:col-span-1">
          <label class="block text-sm text-slate-400 mb-1">Saved lists</label>
          <select id="listsSelect" size="8"
                  class="w-full rounded-lg bg-slate-950/60 border border-slate-700/60 p-2 text-sm"></select>
          <div class="flex gap-2 mt-2">
            <button id="newList" class="px-3 py-1.5 rounded-lg text-sm bg-slate-800 border border-slate-700 hover:bg-slate-700">New</button>
            <button id="loadList" class="px-3 py-1.5 rounded-lg text-sm bg-slate-800 border border-slate-700 hover:bg-slate-700">Load</button>
            <button id="deleteList" class="px-3 py-1.5 rounded-lg text-sm bg-slate-800 border border-slate-700 hover:bg-slate-700">Delete</button>
          </div>
        </div>

        <!-- Editor column -->
        <div class="sm:col-span-2">
          <label class="block text-sm text-slate-400 mb-1">List name</label>
          <input id="listNameInput" class="w-full rounded-lg bg-slate-950/60 border border-slate-700/60 p-2 mb-2" placeholder="e.g. Teachers A" />
          <label class="block text-sm text-slate-400 mb-1">Names (one per line)</label>
          <textarea id="namesEditor" rows="10"
                    class="w-full rounded-lg bg-slate-950/60 border border-slate-700/60 p-3 text-sm"
                    placeholder="Kuang Wen&#10;Gabriel&#10;Adrian"></textarea>
          <div class="flex gap-2 mt-2">
            <button id="saveList" class="px-3 py-1.5 rounded-lg text-sm bg-indigo-600 hover:bg-indigo-500">Save</button>
            <button id="clearEditor" class="px-3 py-1.5 rounded-lg text-sm bg-slate-800 border border-slate-700 hover:bg-slate-700">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const qEl = document.getElementById('q');
    const askBtn = document.getElementById('askBtn');
    const micBtn = document.getElementById('micBtn');
    const statusEl = document.getElementById('status');
    const ansEl = document.getElementById('answer');
    const rawEl = document.getElementById('raw');
    const rawMeta = document.getElementById('rawMeta');
    const copyBtn = document.getElementById('copyBtn');
    const copyTip = document.getElementById('copyTip');
    const rawDetails = document.getElementById('rawDetails');

    // Modal elements
    const manageNamesBtn = document.getElementById('manageNamesBtn');
    const namesModal = document.getElementById('namesModal');
    const closeNames = document.getElementById('closeNames');
    const listsSelect = document.getElementById('listsSelect');
    const listNameInput = document.getElementById('listNameInput');
    const namesEditor = document.getElementById('namesEditor');
    const newListBtn = document.getElementById('newList');
    const loadListBtn = document.getElementById('loadList');
    const deleteListBtn = document.getElementById('deleteList');
    const saveListBtn = document.getElementById('saveList');
    const clearEditorBtn = document.getElementById('clearEditor');

    let recording = false, mediaStream = null, mediaRecorder = null, recordTimer = null;

    function clearOutput() {
      ansEl.innerHTML = '<div class="h-6 rounded skeleton"></div><div class="h-6 rounded skeleton mt-2 w-3/4"></div>';
      rawEl.textContent = '';
      rawMeta.textContent = '';
      rawDetails.open = false;
    }

    async function ask() {
      const question = qEl.value.trim();
      if (!question) return;
      clearOutput();
      setStatus('Sending…');
      askBtn.disabled = true;
      micBtn.disabled = true;

      try {
        const apiRes = await fetch('/proxy', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question, mode: 'auto' }) });
        const data = await apiRes.json();

        rawEl.textContent = JSON.stringify(data, null, 2);
        const count = Array.isArray(data?.results) ? data.results.length : 0;
        rawMeta.textContent = `items: ${count}`;

        setStatus('Summarizing…');
        const results = Array.isArray(data?.results) ? data.results : [];
        const sumRes = await fetch('/summarize', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question, results }) });
        const j = await sumRes.json();
        const summary = j?.choices?.[0]?.message?.content || j?.openai_raw?.choices?.[0]?.message?.content || 'No summary produced.';
        ansEl.innerHTML = DOMPurify.sanitize(marked.parse(summary || ''));
        setStatus('Done');
      } catch (err) {
        ansEl.innerHTML = '<span class="text-red-400">Something went wrong.</span>';
        setStatus('Error');
        console.error(err);
      } finally {
        askBtn.disabled = false;
        micBtn.disabled = false;
      }
    }

    function setStatus(t){ statusEl.textContent = t || ''; }
    qEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ask(); } });
    askBtn.addEventListener('click', ask);

    copyBtn?.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(rawEl.textContent || ''); copyTip.textContent = 'Copied!'; setTimeout(() => copyTip.textContent = '', 1200); } catch {}
    });

    // --- Mic (fills input, improved error reporting) ---
    micBtn.addEventListener('click', async () => {
      try {
        if (!navigator.mediaDevices || !window.MediaRecorder) return alert('Microphone recording not supported.');
        if (!recording) {
          clearOutput();
          setStatus('Recording… tap again to stop');
          micBtn.classList.add('ring-sky');
          mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' });
          const chunks = [];
          mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
          mediaRecorder.onstop = async () => {
            recording = false;
            micBtn.classList.remove('ring-sky');
            setStatus('Transcribing…');
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const form = new FormData();
            form.append('audio', blob, 'question.webm');
            try {
              const r = await fetch('/whisper', { method: 'POST', body: form });
              const j = await r.json();
              if (j?.ok === false) {
                console.warn('Whisper response:', j);
                alert(j.error || 'Transcription failed.');
              } else if (j?.text) {
                qEl.value = j.text.trim();
                qEl.focus();
                qEl.setSelectionRange(qEl.value.length, qEl.value.length);
              } else {
                console.warn('Whisper response (no text):', j);
                alert('No text returned from transcription.');
              }
              setStatus('Ready');
            } catch (e) {
              console.error(e); setStatus('Transcription error');
            } finally {
              mediaStream.getTracks().forEach(t => t.stop());
            }
          };
          mediaRecorder.start();
          recording = true;
          recordTimer = setTimeout(() => { if (recording) mediaRecorder.stop(); }, 6000);
        } else {
          clearTimeout(recordTimer);
          mediaRecorder.stop();
        }
      } catch (e) {
        console.error(e); setStatus('Mic unavailable');
      }
    });

    // ===== Names modal (Create / Load / Save / Delete) =====
    const LS_KEY = 'ttai:names:lists';

    function getLists(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); } catch { return {}; } }
    function setLists(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
    function refreshListsUI(selected=''){
      const lists = getLists();
      listsSelect.innerHTML = '';
      Object.keys(lists).sort().forEach(name => {
        const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
        if (name === selected) opt.selected = true;
        listsSelect.appendChild(opt);
      });
    }

    manageNamesBtn.addEventListener('click', () => { namesModal.classList.add('show'); refreshListsUI(); });
    closeNames.addEventListener('click', () => namesModal.classList.remove('show'));

    newListBtn.addEventListener('click', () => { listNameInput.value=''; namesEditor.value=''; listNameInput.focus(); });
    clearEditorBtn.addEventListener('click', () => { namesEditor.value=''; });

    loadListBtn.addEventListener('click', () => {
      const sel = listsSelect.value;
      if (!sel) return;
      const lists = getLists();
      listNameInput.value = sel;
      namesEditor.value = lists[sel] || '';
    });

    deleteListBtn.addEventListener('click', () => {
      const sel = listsSelect.value;
      if (!sel) return;
      const lists = getLists();
      if (!lists[sel]) return;
      if (!confirm(`Delete list "${sel}"?`)) return;
      delete lists[sel];
      setLists(lists);
      listNameInput.value = '';
      namesEditor.value = '';
      refreshListsUI();
    });

    saveListBtn.addEventListener('click', () => {
      const name = (listNameInput.value || '').trim();
      if (!name) return alert('Please enter a list name.');
      const lists = getLists();
      lists[name] = namesEditor.value.trim();
      setLists(lists);
      refreshListsUI(name);
      alert('Saved.');
    });

    // Tap backdrop to close modal
    namesModal.addEventListener('click', (e) => { if (e.target === namesModal) namesModal.classList.remove('show'); });
  </script>
</body>
</html>
