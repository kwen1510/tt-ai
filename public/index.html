<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Timetable AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    :root { --glass: rgba(15,23,42,.75); }
    body{
      background: radial-gradient(1200px 600px at 20% -10%, #1d2a5b33, transparent 70%),
                  radial-gradient(1000px 500px at 100% 0%, #0ea5e933, transparent 60%),
                  linear-gradient(135deg, #0b1020 0%, #0f172a 50%, #0b1222 100%);
      color:#e5e7eb; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    .card{ background:var(--glass); border:1px solid rgba(148,163,184,.25); backdrop-filter: blur(8px);
           box-shadow:0 20px 60px rgba(0,0,0,.35); }
    .ring-sky{ box-shadow: 0 0 0 2px rgba(56,189,248,.6) inset; }
    .skeleton{ background: linear-gradient(90deg,#0b1222,#0f172a 50%,#0b1222); background-size: 200% 100%;
               animation: sk 1.2s linear infinite; } @keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .markdown-body h1,.markdown-body h2,.markdown-body h3{font-weight:600;margin-top:1rem}
    .markdown-body p,.markdown-body li{margin:0.3rem 0}
    .markdown-body table{border-collapse:collapse;width:100%;margin:0.5rem 0;font-size:0.95rem}
    .markdown-body th,.markdown-body td{border:1px solid #334155;padding:4px 6px;text-align:left}
    .markdown-body code{background:#0f172a;border-radius:4px;padding:2px 4px;font-family:monospace}
    /* Modal */
    .modal-mask{ position:fixed; inset:0; background:rgba(2,6,23,.55); backdrop-filter: blur(4px); display:none; }
    .modal{ width:min(720px,96vw); max-height:90vh; overflow:auto; background:rgba(17,24,39,.96);
            border:1px solid #334155; border-radius:16px; margin:6vh auto; padding:16px; }
    .modal.show{ display:block; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center py-6 px-3 sm:py-10 sm:px-4">

  <main class="w-full max-w-3xl space-y-5">
    <!-- Top bar (no emojis) -->
    <header class="flex items-center justify-between px-1">
      <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">Timetable AI</h1>
      <div class="flex items-center gap-2">
        <button id="manageNamesBtn"
                class="px-3 py-1.5 text-sm rounded-lg bg-slate-800/80 border border-slate-700 hover:bg-slate-700">
          Names
        </button>
        <span class="hidden sm:inline text-sm text-slate-400">Ready</span>
      </div>
    </header>

    <!-- Composer -->
    <section class="card rounded-2xl p-3 sm:p-4">
      <label for="q" class="block text-xs sm:text-sm text-slate-400 mb-2">Ask a question</label>
      <div class="relative">
        <input id="q" autocomplete="off"
               placeholder="e.g. When are Kuang Wenâ€™s free periods tomorrow?"
               class="w-full rounded-2xl bg-slate-950/60 border border-slate-700/60 pl-4 pr-24 py-3 text-base
                      focus:outline-none focus:ring-2 focus:ring-sky-400/70 placeholder:text-slate-500" />
        <!-- Mic button -->
        <button id="micBtn" type="button"
                class="absolute right-2 top-1/2 -translate-y-1/2 inline-flex items-center gap-2
                       rounded-xl px-3 py-2 bg-slate-800/70 border border-slate-700/60 text-slate-200
                       hover:bg-slate-700 transition-all"
                aria-label="Record with microphone" title="Record with microphone">Mic</button>
      </div>
      <div class="mt-3 flex items-center gap-2">
        <button id="askBtn" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl
                                   bg-indigo-600 hover:bg-indigo-500 transition-all font-semibold">
          Ask
        </button>
        <p id="status" class="text-sm text-slate-400"></p>
      </div>
    </section>

    <!-- Answer -->
    <section class="card rounded-2xl p-4 sm:p-5">
      <h2 class="text-lg font-semibold mb-2">Answer</h2>
      <div id="answer" class="markdown-body min-h-[90px] text-base leading-7 text-slate-100">
        <span class="text-slate-400">Ask something to get started.</span>
      </div>
    </section>

    <!-- Raw JSON dropdown -->
    <details class="card rounded-2xl p-3 sm:p-4 select-text" id="rawDetails">
      <summary class="cursor-pointer list-none flex items-center justify-between">
        <span class="font-semibold">Raw JSON (collapsed)</span>
        <span id="rawMeta" class="text-xs text-slate-400"></span>
      </summary>
      <div class="mt-3">
        <div class="flex items-center gap-2 mb-2">
          <button id="copyBtn" class="px-3 py-1.5 rounded-lg text-sm bg-slate-800 border border-slat
